<?php

namespace App\Plugins\AccountingVulnerabilities\Orchid\Screens;

use App\Models\DepartamentType;
use App\Models\Event;
use App\Models\Form;
use App\Models\PreparedEvent;
use App\Models\PreparedFormResult;
use App\Orchid\Components\DateTimeRender;
use App\Orchid\Fields\Button;
use App\Plugins\AccountingVulnerabilities\Models\Vulnerability;
use App\Plugins\AccountingVulnerabilities\Models\VulnerabilityEvent;
use App\Plugins\AccountingVulnerabilities\Models\VulnerabilityEventEvent;
use App\Plugins\AccountingVulnerabilities\Services\VulnerabilityEventCreator;
use Illuminate\Http\Request;
use Orchid\Screen\Actions\DropDown;
use Orchid\Screen\Actions\Link;
use Orchid\Screen\Fields\Select;
use Orchid\Screen\Screen;
use Orchid\Screen\TD;
use Orchid\Support\Facades\Layout;
use Orchid\Support\Facades\Toast;
use Throwable;

class VulnerabilityListScreen extends Screen
{
    public function name(): string
    {
        return 'Сбор и учет уязвимостей';
    }

    public function permission(): ?iterable
    {
        return [
            'platform.plugins.accounting-vulnerabilities.base',
        ];
    }

    public function query(): iterable
    {
        return [
            'vulnerabilities' => Vulnerability::filters()
                ->defaultSort('id', 'desc')
                ->with('softs')
                ->paginate(),

            'events' => VulnerabilityEvent::with(['form', 'user', 'vulnerabilities'])
                ->filters()
                ->defaultSort('id', 'desc')
                ->paginate(),
        ];
    }

    public function commandBar(): array
    {
        return [
            Link::make('Добавить уязвимостей')
                ->icon('plus')
                ->route('platform.plugins.vulnerabilities.create')
        ];
    }

    public function layout(): iterable
    {
        return [
            Layout::block(Layout::rows([
                Select::make('event.departament_types')
                    ->multiple()
                    ->options(DepartamentType::pluck('name', 'id'))
                    ->title('Типы учреждений'),

                Select::make('event.vulnerabilities')
                    ->multiple()
                    ->options(Vulnerability::pluck('name', 'id'))
                    ->title('Уязвимости'),

                Select::make('event.form')
                    ->empty('-')
                    ->options(Form::pluck('name', 'id'))
                    ->title('Форма для рассылки')
                    ->help('Ключи рассылки (указывать с фигурными скобками): <b>{название}</b>, <b>{краткое описание уязвимости}</b>, <b>{id уязвимости в системе идентификации уязвимостей bdu}</b>, <b>{id уязвимости в системе идентификации уязвимостей cve}</b>, <b>{вектор атаки}</b>, <b>{оценка критичности уязвимости}</b>, <b>{возможные меры по устранению уязвимости}</b>, <b>{список по}</b>'),
            ]))
                ->commands([
                    Button::make('Затребовать отчет')
                        ->icon('bs.check')
                        ->method('send'),
                ])
                ->vertical(true),

            // Таблица событий уязвимостей
            Layout::table('events', [
                TD::make(__('Actions'))
                    ->align(TD::ALIGN_CENTER)
                    ->width(100)
                    ->render(fn(VulnerabilityEvent $event) => DropDown::make()
                        ->icon('bs.three-dots-vertical')
                        ->list([
                            Link::make('Выгрузить XLSX #1')->href('#'),
                            Link::make('Выгрузить XLSX #2')->href('#'),
                            Button::make('Выгрузить SQL')->method('exportSql', ['event' => $event->id])->turbo(false),
                        ])),

                TD::make('id', '#')
                    ->sort()
                    ->width(80),

                TD::make('form.name', 'Форма')
                    ->render(function (VulnerabilityEvent $event) {
                        return $event->form?->name;
                    }),

                TD::make('user.name', 'Инициатор')
                    ->render(function (VulnerabilityEvent $event) {
                        return $event->user?->getFullname();
                    }),

                TD::make('vulnerabilities', 'Уязвимости')
                    ->render(function (VulnerabilityEvent $event) {
                        return $event->vulnerabilities->pluck('name')->implode(', ');
                    })
                    ->width(300),

                TD::make('created_at', 'Дата создания')
                    ->usingComponent(DateTimeRender::class)
                    ->sort()
                    ->width(150),
            ]),

            // Оригинальная таблица уязвимостей
            Layout::table('vulnerabilities', [
                TD::make(__('Actions'))
                    ->align(TD::ALIGN_CENTER)
                    ->width(100)
                    ->render(fn(Vulnerability $vulnerability) => DropDown::make()
                        ->icon('bs.three-dots-vertical')
                        ->list([
                            Link::make('История изменений')
                                ->route('platform.plugins.vulnerabilities.history', $vulnerability->id)
                                ->icon('bs.journal'),

                            Link::make(__('Edit'))
                                ->route('platform.plugins.vulnerabilities.edit', $vulnerability->id)
                                ->icon('bs.pencil'),

                            Button::make(__('Delete'))
                                ->icon('bs.trash3')
                                ->confirm('Элемент будет удален')
                                ->method('remove', ['id' => $vulnerability->id]),
                        ])),

                TD::make('id', '#')
                    ->filter(TD::FILTER_NUMERIC)
                    ->sort()
                    ->defaultHidden()
                    ->width(100),

                TD::make('name', 'Название')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('description', 'Описание')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('bdu', 'Идентификатор BDU')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('cve', 'Идентификатор CVE')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('vector', 'Вектор атаки')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('grade', 'Оценка критичности')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('elimination', 'Меры по устранению')
                    ->filter(TD::FILTER_TEXT)
                    ->sort()
                    ->width(200),

                TD::make('created_at', 'Создано')
                    ->usingComponent(DateTimeRender::class)
                    ->filter(TD::FILTER_DATE_RANGE)
                    ->sort()
                    ->width(200),

                TD::make('updated_at', 'Обновлено')
                    ->usingComponent(DateTimeRender::class)
                    ->filter(TD::FILTER_DATE_RANGE)
                    ->sort()
                    ->width(200),
            ]),
        ];
    }

    public function remove(Request $request): void
    {
        Vulnerability::findOrFail($request->input('id'))->delete();
        Toast::info('Успешно удалено!');
    }

    public function removeEvent(Request $request): void
    {
        VulnerabilityEvent::findOrFail($request->input('id'))->delete();
        Toast::info('Событие уязвимости удалено!');
    }

    public function send(Request $request): void
    {
        try {
            VulnerabilityEventCreator::create(
                $request->user(),
                $request->input('event.vulnerabilities', []),
                $request->input('event.departament_types', []),
                $request->input('event.form')
            );

            Toast::info('Успешно создано!');
        } catch (Throwable $e) {
            Toast::error($e->getMessage());
        }
    }

    public function exportSql(Request $request, VulnerabilityEvent $event)
    {
        try {
            // Получаем связанные данные
            $form = $event->form;
            $preparedEvents = PreparedEvent::whereIn('event_id', VulnerabilityEventEvent::where('vulnerability_event_id', $event->id)->select('event_id'))->get();

            throw_if($preparedEvents->isEmpty(), new \Exception('Для этого события нет подготовленных данных'));

            // Транслитерация названия формы для имени таблицы (по правилам Laravel)
            $tableName = \Str::slug($form->name, '_');

            // Формируем SQL
            $sql = "-- SQL экспорт для события уязвимости #{$event->id}\n";
            $sql .= "-- Форма: {$form->name}\n";
            $sql .= "-- Дата создания: {$event->created_at}\n\n";

            // Создание таблицы (определяем структуру по первой записи)
            $firstResults = PreparedFormResult::where('prepared_event_id', $preparedEvents->first()->id)->get();
            $columns = $firstResults->pluck('key')->unique();

            if ($columns->isEmpty()) {
                throw new \Exception('Нет данных для экспорта');
            }

            $sql .= "CREATE TABLE IF NOT EXISTS `{$tableName}` (\n";
            $sql .= "  `id` INT NOT NULL AUTO_INCREMENT,\n";

            foreach ($columns as $column) {
                $column = \Str::slug($column, '_');
                $sql .= "  `{$column}` TEXT NULL COMMENT '{$column}',\n";
            }

            $sql .= "  PRIMARY KEY (`id`)\n";
            $sql .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n";

            $results = PreparedFormResult::whereIn('prepared_event_id', $preparedEvents->pluck('id'))->get()->groupBy('prepared_event_id');

            // Вставка данных из всех PreparedEvent
            foreach ($preparedEvents as $preparedEvent) {
                $formResults = $results->get($preparedEvent->id)->groupBy('index');
                foreach ($formResults as $rowGroup) {
                    $rowGroup->map(function ($row) {
                        $row->key = \Str::slug($row->key, '_');
                        return $row;
                    });

                    $sql .= "INSERT INTO `{$tableName}` (\n";
                    $sql .= "  " . $rowGroup->pluck('key')->implode(",\n  ") . "\n";
                    $sql .= ") VALUES (\n";
                    $sql .= "  " . $rowGroup->map(fn($item) => $item->value ? "'" . addslashes($item->value) . "'" : 'NULL')->implode(",\n  ") . "\n";
                    $sql .= ");\n\n";
                }
            }

            return response($sql)
                ->header('Content-Type', 'text/plain')
                ->header('Content-Disposition', "attachment; filename={$tableName}_export.sql");
        } catch (\Exception $e) {
            Toast::error($e->getMessage());
            return back();
        }
    }
}
