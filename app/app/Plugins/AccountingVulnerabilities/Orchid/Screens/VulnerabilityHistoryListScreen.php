<?php

namespace App\Plugins\AccountingVulnerabilities\Orchid\Screens;

use App\Plugins\AccountingVulnerabilities\Models\Vulnerability;
use App\Plugins\EntityLogger\Models\EntityLog;
use Illuminate\Support\Collection;
use Orchid\Screen\Screen;
use Orchid\Screen\TD;
use Orchid\Support\Facades\Layout;

class VulnerabilityHistoryListScreen extends Screen
{
    protected Vulnerability $vulnerability;
    protected Collection $logs;

    public function name(): string
    {
        return "История уязвимости \"{$this->vulnerability->name}\"";
    }

    public function permission(): ?iterable
    {
        return [
            'platform.plugins.accounting-vulnerabilities.base',
        ];
    }

    public function query(Vulnerability $vulnerability): iterable
    {
        $this->vulnerability = $vulnerability;
        $this->logs = EntityLog::query()
            ->orderBy('id', 'desc')
            ->where('model', Vulnerability::class)
            ->where('fields', 'ILIKE', "%\"id\":{$this->vulnerability->id}%")
            ->get();

        return [
            'vulnerability' => $this->vulnerability,
            'logs' => $this->logs,
        ];
    }

    public function layout(): iterable
    {
        return [
            Layout::table('logs', [
                TD::make('id', '#'),
                TD::make('message', 'Тип'),
                TD::make('model', 'Модель'),
                TD::make('fields', 'Поля'),
                TD::make('user', 'Пользователь'),
                TD::make('ip', 'IP'),
                TD::make('created_at', 'Дата создания'),
            ]),
        ];
    }
}
